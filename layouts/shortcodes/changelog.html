{{ $path := path.Join "changelog" }}

{{ $config_file := path.Join $path "pyproject.toml" }}
{{ $config := readFile $config_file | transform.Unmarshal }}
{{ $types := dict }}
{{ range $config.tool.towncrier.type }}
    {{ $types = merge $types (dict .directory (slice)) }}
{{ end }}

{{ $news_path := path.Join $path "newsfragments" }}

{{ range (readDir $news_path) }}

    {{ $pieces := split .Name "." }}

    {{ $ticket := index $pieces 0 }}
    {{ $description := readFile (path.Join $news_path .Name ) }}
    {{ $change_info := (dict "ticket" $ticket "description" $description )}}

    {{ $type := index $pieces 1 }}
    {{ $instances := index $types $type }}
    {{ $instances = $instances | append $change_info }}
    {{ $types = merge $types (dict $type $instances) }}

{{ end }}

{{ if eq .Site.Params.version.status "unstable" }}
<p>This is the <strong>unstable</strong> version of the Matrix specification.</p>
{{ else }}
<p>This is version {{ .Site.Params.version.version_number }} of the Matrix specification.</p>
{{ end }}

<h2>Changes</h2>

<p>This section lists notable changes since the previous version.</p>

{{ range $config.tool.towncrier.type }}
<h3 id="{{.directory}}">{{.name}}</h3>
    {{ $changes_of_type := (index $types .directory) }}
    {{ if $changes_of_type }}
<ul>
        {{ range $changes_of_type }}
<li><a href="https://github.com/matrix-org/matrix-doc/issues/{{.ticket}}"><strong>{{ .ticket }}: </strong></a>{{ .description | markdownify }}</li>
        {{ end }}
</ul>
    {{ else }}
<p>None.
    {{ end }}
{{ end }}
