{{ $schema := .schema }}
{{ $base_data := .base_data }}
{{ $path := .path}}

{{ $ret := $schema }}

{{ if reflect.IsMap $schema }}

    {{ $result_map := dict }}

    {{ $ref_value := index $schema "$ref"}}
    {{ if $ref_value}}
        {{ $full_path := path.Join $path $ref_value }}
        {{ $without_ext := replaceRE "\\.[^\\.]*$" "" $full_path }}
        {{ $pieces := split $without_ext "/" }}

        {{ $ref := $base_data }}
        {{ range $pieces}}
            {{ if not $ref }}
                {{ errorf "Failed to handle page %q" $full_path }}
            {{ end }}
            {{ $ref = index $ref . }}
        {{ end }}

        {{ $new_path := (path.Split $full_path).Dir}}
        {{ $result_map = partial "openapi/resolvers/resolve-refs" (dict "schema" $ref "base_data" $base_data "path" $new_path)}}
    {{ end }}

    {{ range $key, $value := $schema }}
        {{ if ne $key "$ref" }}
            {{ $resolved := partial "openapi/resolvers/resolve-refs" (dict "schema" $value "base_data" $base_data "path" $path) }}
            {{ $result_map = merge $result_map (dict $key $resolved) }}
        {{ end }}
    {{ end }}

    {{ $ret = $result_map }}

{{ end }}

{{ if reflect.IsSlice $schema }}

    {{ $result_slice := slice }}

    {{ range $schema }}
        {{ $resolved := partial "openapi/resolvers/resolve-refs" (dict "schema" . "base_data" $base_data "path" $path) }}
        {{ $result_slice = $result_slice | append $resolved }}
    {{ end }}

    {{ $ret = $result_slice }}

{{ end }}

{{ return $ret }}
